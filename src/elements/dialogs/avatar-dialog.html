<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../../bower_components/skeleton-carousel/skeleton-carousel.html">

<link rel="import" href="../../mixins/utils-functions.html">
<link rel="import" href="../../mixins/redux-mixin.html">
<link rel="import" href="../text-truncate.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="dialog-styles.html">

<dom-module id="avatar-dialog">
  <template>
    <style is="custom-style" include="shared-styles dialog-styles flex flex-alignment positioning"></style>

    <style>
      :host {
        display: block;
      }

      #heads_carousel,
      #bodies_carousel,
      #legs_carousel {
        max-width: 440px;
        --skeleton-carousel-min-height: 220px;
      }

      .carousel-wrapper {
        display: flex;
        justify-content: center;
      }

      .nav-container {
        display: flex;
        align-items: center;
      }

      .warning-label {
        color: red;
      }

      .submit-avatar {
        margin: 5px;
      }
    </style>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" class="header" fixed="[[viewport.isTabletPlus]]" style$="background-color: [[_getSessionColor(session.track.color, session.icon, session.color)]]">
        <iron-icon
          class="close-icon"
          icon="hoverboard:[[_getCloseBtnIcon(viewport.isLaptopPlus)]]"
          on-tap="close"
        ></iron-icon>
      </app-header>
      <div class="dialog-container content" id="avatar-dialog-content">
        <div class="additional-sections">
          <div class="avatar-container">
              <div class="carousel-wrapper">
                <paper-input
                  label="{$ avatarBlock.nameYourAvatar $}" 
                  value="{{avatarName}}">
                </paper-input>
                <paper-button class="submit-avatar" on-tap="_submitAvatar" raised>{$ avatarBlock.submitAvatar $}</paper-button>
              </div>
              <div class="carousel-wrapper">
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevHead"></paper-icon-button>
                </div>
                <skeleton-carousel id="heads_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
                  {% for head in avatarParts.heads %}
                    <div title="Swipe left and right to swap heads">
                      <iron-image src="{$ head $}" preload fade></iron-image>
                    </div>
                  {% endfor %}
                </skeleton-carousel>
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextHead"></paper-icon-button>
                </div>
              </div>
              <div class="carousel-wrapper">
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevBody"></paper-icon-button>
                </div>
                <skeleton-carousel id="bodies_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
                  {% for body in avatarParts.bodies %}
                    <div title="Swipe left and right to swap bodies">
                      <iron-image src="{$ body $}" preload fade></iron-image>
                    </div>
                  {% endfor %}
                </skeleton-carousel>
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextBody"></paper-icon-button>
                </div>
              </div>
              <div class="carousel-wrapper">
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevLegs"></paper-icon-button>
                </div>
                <skeleton-carousel nav id="legs_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
                  {% for leg in avatarParts.legs %}
                    <div title="Swipe left and right to swap legs">
                      <iron-image src="{$ leg $}" preload fade></iron-image>
                    </div>
                  {% endfor %}
                </skeleton-carousel>
                <div class="nav-container">
                  <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextLegs"></paper-icon-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </app-header-layout>

  </template>

  <script>

    class AvatarDialog extends UtilsFunctions(ReduxMixin(Polymer.mixinBehaviors([Polymer.IronOverlayBehavior], Polymer.Element))) {
      static get is() {
        return 'avatar-dialog';
      }

      static get properties() {
        return {
          viewport: {
            type: Object,
            statePath: 'ui.viewport'
          },
          participants: {
            type: Object,
            statePath: 'participants'
          },
          user: {
            type: Object,
            statePath: 'user'
          },
          avatarName: {
            type: String,
            default: ''
          },
          avatar: {
            type: Object,
            statePath: 'avatar'
          }
        }
      }

      constructor() {
        super();
        this.addEventListener('iron-overlay-canceled', this._close);
        this.addEventListener('iron-overlay-opened', this._open);
      }

      static get observers() {
        return [
          '_handleClose(opened, session)'
        ];
      }

      _close() {
        dialogsActions.closeDialog(DIALOGS.SESSION);
      }

      _handleClose(opened, session) {
        if (!opened && session && Object.keys(session).length) {
          dialogsActions.closeDialog(DIALOGS.SESSION);
        }
      }

      _open() {
        if (!this.user && !this.user.uid)
          return;
        if (!this.participants || !this.participants.list || !Object.keys(this.participants.list).length)
          participantsActions.fetchList();
        if (Object.keys(this.participants.list).indexOf(this.user.uid) < 0)
          return;
        let part = this.participants.list[this.user.uid];
        if (Object.keys(part).length > 0) {
          this.avatarName = part.name;
          this.$.heads_carousel.selected = part.head;
          this.$.bodies_carousel.selected = part.body;
          this.$.legs_carousel.selected = part.legs;
        }
      }

      _getCloseBtnIcon(isLaptopViewport) {
        return isLaptopViewport ? 'close' : 'arrow-left';
      }

      _notFullyLoggedIn(user) {
        return !this.user || !this.user.signedIn || this.user.isAnonymous;
      }

      _prevHead() {
        this.$.heads_carousel.prev();
      }

      _nextHead() {
        this.$.heads_carousel.next();
      }

      _prevBody() {
        this.$.bodies_carousel.prev();
      }

      _nextBody() {
        this.$.bodies_carousel.next();
      }

      _prevLegs() {
        this.$.legs_carousel.prev();
      }

      _nextLegs() {
        this.$.legs_carousel.next();
      }

      _submitAvatar() {
        if (this._notFullyLoggedIn(this.user)) {
          toastActions.showToast({
            message: '{$ avatarBlock.submitAvatarSignedIn $}',
            action: {
              title: 'Sign in',
              callback: () => {
                dialogsActions.openDialog(DIALOGS.SIGNIN);
              }
            }
          });
          return;
        }

        let avatar = {
          'name': this.avatarName,
          'head': this.$.heads_carousel.selected,
          'body': this.$.bodies_carousel.selected,
          'legs': this.$.legs_carousel.selected
        }
        this.participants.participant = avatar;
        participantsActions.setUserParticipant(this.user.uid, avatar);
        toastActions.showToast({
          message: 'Avatar saved',
          action: {
            title: 'Androidify',
            callback: () => {}
          }
        });
      }
    }

    window.customElements.define(AvatarDialog.is, AvatarDialog);
  </script>
</dom-module>
