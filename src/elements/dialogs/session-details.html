<link rel="import" href="../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../../../bower_components/plastic-image/plastic-image.html">
<link rel="import" href="../../../bower_components/iron-autogrow-textarea/iron-autogrow-textarea.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../star-rating.html">

<link rel="import" href="../../mixins/utils-functions.html">
<link rel="import" href="../../mixins/redux-mixin.html">
<link rel="import" href="../text-truncate.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="dialog-styles.html">

<dom-module id="session-details">
  <template>
    <style is="custom-style" include="shared-styles dialog-styles flex flex-alignment positioning"></style>

    <style>
      span.rating-title {
        margin-top: 10px;
        margin-right: 20px;
      }
      iron-autogrow-textarea {
        width: 100%;
      }
    </style>

    <app-header-layout has-scrolling-region>
      <app-header slot="header" class="header" fixed="[[viewport.isTabletPlus]]" style$="background-color: [[_getSessionColor(session.track.color, session.icon, session.color)]]">
        <iron-icon
          class="close-icon"
          icon="hoverboard:[[_getCloseBtnIcon(viewport.isLaptopPlus)]]"
          on-tap="close"
        ></iron-icon>
        <app-toolbar>
          <div class="dialog-container header-content" layout vertical end-justified>
            <!-- https://github.com/Polymer/TemplateBinding/issues/57 -->
            <h2 class="name" inner-h-t-m-l="[[session.title]]"></h2>
            <div class="tags" hidden$="[[!session.tags.length]]">
              <template is="dom-repeat" items="[[session.tags]]" as="tag">
                <span class="tag" style$="color: [[_getTagColor(tag)]]">[[tag]]</span>
              </template>
            </div>

            <div class="float-button">
              <paper-fab
                icon="hoverboard:[[_getFeaturedSessionIcon(featuredSessions, session.id)]]"
                hidden$="[[!viewport.isLaptopPlus]]"
                on-tap="_toggleFeaturedSession"
                title="Bookmark Session"
              ></paper-fab>
              <paper-fab
                icon="hoverboard:calendar"
                hidden$="[[!viewport.isLaptopPlus]]"
                on-tap="_addToCalendar"
                title="Add To Calendar"
              ></paper-fab>
            </div>
          </div>
        </app-toolbar>
      </app-header>

      <div class="dialog-container content">
        <div class="float-button">
          <paper-fab
            icon="hoverboard:[[_getFeaturedSessionIcon(featuredSessions, session.id)]]"
            hidden$="[[viewport.isLaptopPlus]]"
            on-tap="_toggleFeaturedSession"
          ></paper-fab>
        </div>
        <h3 class="meta-info">Time: [[session.startTime2]] - [[session.endTime2]]</h3>
        <h3 class="meta-info" hidden$="[[!session.complexity]]">{$ sessionDetails.contentLevel $}:
          [[session.complexity]]</h3>
        <h3 class="meta-info" hidden$="[[session.icon]]">Location: [[session.track.location]]</h3>
        <h3 class="meta-info" hidden$="[[!session.location]]">Location: [[session.location]]</h3>
        <h3 class="meta-info">Track: [[session.track.title]]</h3>
        
        <marked-element class="description" markdown="[[session.description]]">
          <div slot="markdown-html"></div>
        </marked-element>

        <div class="actions" layout horizontal>
          <a
            class="action"
            href$="[[session.presentation]]"
            hidden$="[[!session.presentation]]"
            target="_blank"
            rel="noopener noreferrer"
            layout horizontal center-aligned
          >
            <iron-icon icon="hoverboard:presentation"></iron-icon>
            <span>{$ sessionDetails.viewPresentation $}</span>
          </a>
          <div
            class="action"
            hidden$="[[!session.videoId]]"
            on-tap="_openVideo"
            layout horizontal center-aligned
          >
            <iron-icon icon="hoverboard:video"></iron-icon>
            {$ sessionDetails.viewVideo $}
          </div>
        </div>

        <div class="additional-sections" hidden$="[[!session.speakers.length]]">
          <h3>{$ sessionDetails.speakers $}</h3>

          <template is="dom-repeat" items="[[session.speakers]]" as="speaker">
            <a href$="/speakers/[[speaker.id]]" class="section" on-tap="close">
              <div layout horizontal center>
                <plastic-image
                  class="section-photo"
                  srcset="[[speaker.photoUrl]]"
                  sizing="cover"
                  lazy-load preload fade
                ></plastic-image>

                <div class="section-details" flex>
                  <div class="section-primary-text">[[speaker.name]]</div>
                  <div class="section-secondary-text">[[speaker.company]]</div>
                </div>
              </div>
            </a>
          </template>
        </div>

        <div class="additional-sections">
          <h2>{$ scheduleBlock.ratings.title $}</h2>

          <div layout horizontal>
            <span class="rating-title">{$ scheduleBlock.ratings.categories.content $}: </span>
            <star-rating
              session-id="[[session.id]]"
              rating-category="content"
              rate="[[content]]"
              ratings="[[ratings]]"
              user="[[user]]"
            ></star-rating>
          </div>
          <div layout horizontal>
            <span class="rating-title">{$ scheduleBlock.ratings.categories.presentation $}: </span>
            <star-rating
              session-id="[[session.id]]"
              rating-category="presentation"
              rate="[[presentation]]"
              ratings="[[ratings]]"
              user="[[user]]"
            ></star-rating>
          </div>
          <div layout horizontal>
            <span class="rating-title">{$ scheduleBlock.ratings.categories.venue $}: </span>
            <star-rating
              session-id="[[session.id]]"
              rating-category="venue"
              rate="[[venue]]"
              ratings="[[ratings]]"
              user="[[user]]"
            ></star-rating>
          </div>
        
          <iron-autogrow-textarea bind-value="{{comment}}" rows="3" maxRows="10" placeholder="{$ scheduleBlock.ratings.commentPlaceholder $}"></iron-autogrow-textarea>
          <paper-button class="session-comment" on-tap="_submitComment" raised>{$ scheduleBlock.ratings.submitComment $}</paper-button>
        </div>
      </div>
    </app-header-layout>

  </template>

  <script>

    class SessionDetails extends UtilsFunctions(ReduxMixin(Polymer.mixinBehaviors([Polymer.IronOverlayBehavior], Polymer.Element))) {
      static get is() {
        return 'session-details';
      }

      static get properties() {
        return {
          session: {
            type: Object
          },
          ratings: {
            type: Object,
            statePath: 'ratings'
          },
          viewport: {
            type: Object,
            statePath: 'ui.viewport'
          },
          user: {
            type: Object,
            statePath: 'user'
          },
          featuredSessions: {
            type: Object,
            statePath: 'sessions.featured'
          },
          comment: {
            type: String,
            value: ''
          },
          content: {
            type: Number,
            value: 0
          },
          presentation: {
            type: Number,
            value: 0
          },
          venue: {
            type: Number,
            value: 0
          }
        }
      }

      constructor() {
        super();
        this.addEventListener('iron-overlay-canceled', this._close);
        this.addEventListener('iron-overlay-opened', this._open);
      }

      static get observers() {
        return [
          '_handleClose(opened, session)'
        ];
      }

      _close() {
        dialogsActions.closeDialog(DIALOGS.SESSION);
      }

      _handleClose(opened, session) {
        if (!opened && session && Object.keys(session).length) {
          dialogsActions.closeDialog(DIALOGS.SESSION);
        }
      }

      _open() {
        if (this.session && this.ratings && this.session.id in this.ratings) {
          if ('comment' in this.ratings[this.session.id]) {
            this.comment = this.ratings[this.session.id]['comment'];
          } else {
            this.comment = '';
          }
          if ('content' in this.ratings[this.session.id]) {
            this.content = this.ratings[this.session.id]['content'];
          } else {
            this.content = 0;
          }
          if ('presentation' in this.ratings[this.session.id]) {
            this.presentation = this.ratings[this.session.id]['presentation'];
          } else {
            this.presentation = 0;
          }
          if ('venue' in this.ratings[this.session.id]) {
            this.venue = this.ratings[this.session.id]['venue'];
          } else {
            this.venue = 0;
          }
        } else {
          this.comment = '';
          this.content = 0;
          this.presentation = 0;
          this.venue = 0;
        }
      }

      _getTagColor(value) {
        if (ShadyCSS) {
          return ShadyCSS.getComputedStyleValue(this, `--${this.generateClassName(value)}`);
        }
        return getComputedStyle(this, `--${this.generateClassName(value)}`);
      }

      _getSessionColor(trackColor, multiTrack, sessionColor) {
        if (multiTrack)
          return sessionColor ? sessionColor : '#ffffff';
        return trackColor;
      }

      _getCloseBtnIcon(isLaptopViewport) {
        return isLaptopViewport ? 'close' : 'arrow-left';
      }

      _openVideo() {
        uiActions.toggleVideoDialog({
          title: this.session.title,
          youtubeId: this.session.videoId,
          disableControls: true,
          opened: true
        });
      }

      _toggleFeaturedSession(event) {
        event.preventDefault();
        event.stopPropagation();
        if (!this.user.signedIn || this.user.isAnonymous) {
          toastActions.showToast({
            message: '{$ schedule.saveSessionsSignedOut $}',
            action: {
              title: 'Sign in',
              callback: () => {
                dialogsActions.openDialog(DIALOGS.SIGNIN);
              }
            }
          });
          return;
        }
        const sessions = Object.assign({}, this.featuredSessions, {
          [this.session.id]: !this.featuredSessions[this.session.id] ? true : null
        });

        sessionsActions.setUserFeaturedSessions(this.user.uid, sessions);
      }
      
      _addToCalendar(event) {
        // https://stackoverflow.com/questions/5831877/how-do-i-create-a-link-to-add-an-entry-to-a-calendar
        // https://stackoverflow.com/questions/10763734/how-to-build-html-link-to-a-google-calendar-event
        var dateStr = this.session.day.replace(/-/gi, '');
        var startStr = dateStr + 'T' + this.session.startTime.replace(':', '') + '00';
        var endStr = dateStr + 'T' + this.session.endTime.replace(':', '') + '00';
        window.open(
          'https://www.google.com/calendar/render?action=TEMPLATE&' +
          'text=' + encodeURI(this.session.title) + '&' +
          'dates=' + startStr + '/' + endStr + '&' +
          'details=' + encodeURI(this.session.description) + '&' +
          'location=' + encodeURI('700 Van Ness Avenue, Fresno, CA'),
          '_blank'
        );
      }

      _getFeaturedSessionIcon(featuredSessions, sessionId) {
        return featuredSessions && featuredSessions[sessionId] ? 'bookmark-check' : 'bookmark-plus';
      }

      _submitComment(event) {
        if (!this.comment) return;
        if (!(this.session.id in this.ratings)) {
          this.ratings[this.session.id] = {};
        }
        this.ratings[this.session.id]['comment'] = this.comment;
        ratingsActions.setUserSessionRatings(this.user.uid, this.ratings);
      }

    }

    window.customElements.define(SessionDetails.is, SessionDetails);
  </script>
</dom-module>
