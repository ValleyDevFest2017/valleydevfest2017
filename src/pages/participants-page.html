<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">
<link rel="import" href="../../bower_components/plastic-image/plastic-image.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../mixins/redux-mixin.html">
<link rel="import" href="../elements/shared-styles.html">

<dom-module id="participants-page">
  <template>
    <style is="custom-style" include="shared-styles flex flex-alignment"></style>

    <style>

      :host  {
        display: block;
      }

      .avatar-block {
        max-width: 440px;
      }
      .avatar-block plastic-image {
        max-width: 200px;
        --iron-image-width: 100%;
      }
    </style>

    <div class="container">
      <paper-button on-tap="_yourAvatar" raised>{$ avatarBlock.yourAvatar $}</paper-button>
      <div layout horizontal wrap>
        <template is="dom-repeat" items="[[_getRandomParticipantList(participants.list)]]" as="participant">
          <div class="avatar-block">
            <div class="avatar" layout vertical>
              <plastic-image
                srcset="[[participant.headUrl]]"
                lazy-load preload fade>
              </plastic-image>
              <plastic-image
                srcset="[[participant.bodyUrl]]"
                lazy-load preload fade>
              </plastic-image>
              <plastic-image
                srcset="[[participant.legsUrl]]"
                lazy-load preload fade>
              </plastic-image>

              <div layout horizontal center-justified>
                <h2 class="name">[[participant.name]]</h2>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>

    class ParticipantsPage extends ReduxMixin(Polymer.Element) {
      static get is() { return 'participants-page' }

       static get properties() {
        return {
          participants: {
            type: Object,
            statePath: 'participants'
          },
          user: {
            type: Object,
            statePath: 'user'
          }
        };
      }

      getHeadUrl(partIndex) {
        let i = 1;
        return "https://firebasestorage.googleapis.com/v0/b/vdf2017-3a9f6.appspot.com/o/avatar%2Fhead1.png?alt=media&token=5cfcf8e5-9045-432d-87c3-fc3ea9fc0b18";
      }

      getBodyUrl(partIndex) {
        return "https://firebasestorage.googleapis.com/v0/b/vdf2017-3a9f6.appspot.com/o/avatar%2Fbody1.png?alt=media&token=77ed748c-6588-41d0-9e92-2738f81c44c9";
      }

      getLegsUrl(partIndex) {
        return "https://firebasestorage.googleapis.com/v0/b/vdf2017-3a9f6.appspot.com/o/avatar%2Flegs1.png?alt=media&token=8d37f3e0-930c-4c12-bed8-9fe665c3d80a";
      }

      _getRandomParticipantList(pList) {
        if (!pList)
          return [];
        console.log(JSON.stringify(pList));
        let that = this;
        let arr = Object.keys(pList).map(function(key) {
          return {
            name: pList[key].name,
            headUrl: that.getHeadUrl(pList[key].head),
            bodyUrl: that.getBodyUrl(pList[key].body),
            legsUrl: that.getLegsUrl(pList[key].legs),
          }
        });
        return [].concat(arr, arr, arr, arr);
      }

      _notFullyLoggedIn(user) {
        return !this.user.signedIn || this.user.isAnonymous;
      }

      _yourAvatar() {
        if (this._notFullyLoggedIn(this.user)) {
          toastActions.showToast({
            message: '{$ avatarBlock.submitAvatarSignedIn $}',
            action: {
              title: 'Sign in',
              callback: () => {
                dialogsActions.openDialog(DIALOGS.SIGNIN);
              }
            }
          });
          return;
        }
        window.location = '/avatar';
      }

      connectedCallback() {
        super.connectedCallback();
        participantsActions.fetchList();
      }
    }

    window.customElements.define(ParticipantsPage.is, ParticipantsPage);

  </script>
</dom-module>

