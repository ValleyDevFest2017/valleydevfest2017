<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">
<link rel="import" href="../../bower_components/plastic-image/plastic-image.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../mixins/utils-functions.html">
<link rel="import" href="../mixins/redux-mixin.html">
<link rel="import" href="../elements/shared-styles.html">

<dom-module id="participants-page">
  <template>
    <style is="custom-style" include="shared-styles flex flex-alignment"></style>

    <style>
      :host  {
        display: block;
      }

      .avatar-block {
        max-width: 440px;
      }

      .avatar-block plastic-image {
        max-width: 200px;
        --iron-image-width: 100%;
      }

      paper-button {
        margin: 5px;
      }
    </style>

    <div class="container">
      <paper-button on-tap="_yourAvatar" raised>{$ avatarBlock.yourAvatar $}</paper-button>
      <paper-button on-tap="_androidApp" raised>{$ avatarBlock.androidApp $}</paper-button>
      <div layout horizontal wrap>
        <template is="dom-repeat" items="[[_getRandomFilteredParticipantList(participants.list)]]" as="participant">
          <div class="avatar-block">
            <div class="avatar" layout vertical>
              <plastic-image
                srcset="[[participant.headUrl]]"
                lazy-load preload fade>
              </plastic-image>
              <plastic-image
                srcset="[[participant.bodyUrl]]"
                lazy-load preload fade>
              </plastic-image>
              <plastic-image
                srcset="[[participant.legsUrl]]"
                lazy-load preload fade>
              </plastic-image>

              <div layout horizontal center-justified>
                <h2 class="name">[[participant.name]]</h2>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>

    class ParticipantsPage extends UtilsFunctions(ReduxMixin(Polymer.Element)) {
      static get is() { return 'participants-page' }

       static get properties() {
        return {
          participants: {
            type: Object,
            statePath: 'participants'
          },
          user: {
            type: Object,
            statePath: 'user'
          },
          avatar: {
            type: Object,
            statePath: 'avatar'
          }
        };
      }

      // https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
      _shuffle(array) {
        let currentIndex = array.length, temporaryValue, randomIndex;
        while (0 !== currentIndex) {
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex -= 1;

          temporaryValue = array[currentIndex];
          array[currentIndex] = array[randomIndex];
          array[randomIndex] = temporaryValue;
        }
        return array;
      }

      _getHeadUrl(partIndex) {
        return this.avatar.heads[partIndex];
      }

      _getBodyUrl(partIndex) {
        return this.avatar.bodies[partIndex];
      }

      _getLegsUrl(partIndex) {
        return this.avatar.legs[partIndex];
      }

      _getRandomParticipantList(pList) {
        if (!pList || Object.keys(pList).length <= 0) {
          return [];
        }
        let that = this;
        return this._shuffle(Object.keys(pList)).map(function(key) {
          return {
            name: pList[key].name,
            headUrl: that._getHeadUrl(pList[key].head - 1),
            bodyUrl: that._getBodyUrl(pList[key].body - 1),
            legsUrl: that._getLegsUrl(pList[key].legs - 1)
          }
        });
      }

      _getRandomFilteredParticipantList(pList) {
        let rndList = this._getRandomParticipantList(pList);
        let reduced = rndList.reduce(function(filtered, avtr) {
          if (avtr.name && avtr.name.length > 0 || avtr.head * avtr.body * avtr.legs > 1) {
            filtered.push(avtr);
          }
          return filtered;
        }, []);
        return reduced;
      }

      _notFullyLoggedIn(user) {
        return !this.user.signedIn || this.user.isAnonymous;
      }

      _yourAvatar() {
        if (this._notFullyLoggedIn(this.user)) {
          toastActions.showToast({
            message: '{$ avatarBlock.submitAvatarSignedIn $}',
            action: {
              title: 'Sign in',
              callback: () => {
                dialogsActions.openDialog(DIALOGS.SIGNIN);
              }
            }
          });
          return;
        }
        requestAnimationFrame(() => {
            let data = {
              'user': this.user,
              'avatar': this.avatar,
              'participant': this.participants.participant
            }
            dialogsActions.openDialog(DIALOGS.AVATAR, data);
            // dialogsActions.closeDialog(DIALOGS.AVATAR);
          }
        )
      }

      _androidApp() {
        window.open("{$ avatarBlock.appStoreUrl $}");
      }

      connectedCallback() {
        super.connectedCallback();
        participantsActions.fetchList();
        avatarActions.fetchAvatarParts();
      }
    }

    window.customElements.define(ParticipantsPage.is, ParticipantsPage);

  </script>
</dom-module>

