<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/skeleton-carousel/skeleton-carousel.html">

<link rel="import" href="../mixins/utils-functions.html">
<link rel="import" href="../mixins/redux-mixin.html">
<link rel="import" href="../elements/shared-styles.html">

<dom-module id="avatar-page">
  <template>
    <style is="custom-style" include="shared-styles flex flex-alignment"></style>

    <style>
      :host {
        display: block;
      }

      #heads_carousel,
      #bodies_carousel,
      #legs_carousel {
        max-width: 440px;
        --skeleton-carousel-min-height: 220px;
      }

      .carousel-wrapper {
        display: flex;
        justify-content: center;
      }

      .nav-container {
        display: flex;
        align-items: center;
      }

      .warning-label {
        color: red;
      }
    </style>

    <div class="container">
      <label class="warning-label" hidden$="{{!_notFullyLoggedIn(user)}}">{$ avatarBlock.editAvatarSignedIn $}</label>
      <div class="avatar-container">
        <div class="carousel-wrapper">
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevHead"></paper-icon-button>
          </div>
          <skeleton-carousel id="heads_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
            {% for head in avatarParts.heads %}
              <div title="Swipe left and right to swap heads">
                <iron-image src="{$ head $}" preload fade></iron-image>
              </div>
            {% endfor %}
          </skeleton-carousel>
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextHead"></paper-icon-button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevBody"></paper-icon-button>
          </div>
          <skeleton-carousel id="bodies_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
            {% for body in avatarParts.bodies %}
              <div title="Swipe left and right to swap bodies">
                <iron-image src="{$ body $}" preload fade></iron-image>
              </div>
            {% endfor %}
          </skeleton-carousel>
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextBody"></paper-icon-button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-left" on-tap="_prevLegs"></paper-icon-button>
          </div>
          <skeleton-carousel nav id="legs_carousel" disabled$="{{_notFullyLoggedIn(user)}}">
            {% for leg in avatarParts.legs %}
              <div title="Swipe left and right to swap legs">
                <iron-image src="{$ leg $}" preload fade></iron-image>
              </div>
            {% endfor %}
          </skeleton-carousel>
          <div class="nav-container">
            <paper-icon-button icon="hoverboard:chevron-right" on-tap="_nextLegs"></paper-icon-button>
          </div>
        </div>
        <div class="carousel-wrapper">
          <paper-input
            label="{$ avatarBlock.nameYourAvatar $}" 
            value="{{avatarName}}">
          </paper-input>
          <paper-button class="submit-avatar" on-tap="_submitAvatar" raised>{$ avatarBlock.submitAvatar $}</paper-button>
        </div>
      </div>
    </div>
  </template>

  <script>
    class AvatarPage extends ScrollFunctions(Polymer.Element) {
      static get is() {
        return 'avatar-page'
      }

      static get properties() {
        return {
          participants: {
            type: Object,
            statePath: 'participants'
          },
          user: {
            type: Object,
            statePath: 'user'
          },
          avatarName: {
            type: String,
            default: ''
          },
          avatar: {
            type: Object,
            statePath: 'avatar'
          }
        }
      }

      static get observers() {
        return [
          '_fetchUserParticipant(active, user.uid)',
        ];
      }

      _fetchUserParticipant(active, userUid) {
        if (active && userUid && !this.participants.participant) {
          participantsActions._fetchUserParticipant(userUid);
        }
      }

      ready() {
        super.ready();
        if (this.user && (!this.participants || !this.participants.participant || !Object.keys(this.participants.participant).length))
          participantsActions.fetchUserParticipant(this.user.id);
        let part = this.participants.participant;
        if (Object.keys(part).length > 0) {
          this.avatarName = part.name;
          this.$.heads_carousel.selected = part.head;
          this.$.bodies_carousel.selected = part.body;
          this.$.legs_carousel.selected = part.legs;
        }
      }

      _notFullyLoggedIn(user) {
        return !this.user.signedIn || this.user.isAnonymous;
      }

      _prevHead() {
        this.$.heads_carousel.prev();
      }

      _nextHead() {
        this.$.heads_carousel.next();
      }

      _prevBody() {
        this.$.bodies_carousel.prev();
      }

      _nextBody() {
        this.$.bodies_carousel.next();
      }

      _prevLegs() {
        this.$.legs_carousel.prev();
      }

      _nextLegs() {
        this.$.legs_carousel.next();
      }

      _submitAvatar() {
        if (this._notFullyLoggedIn(this.user)) {
          toastActions.showToast({
            message: '{$ avatarBlock.submitAvatarSignedIn $}',
            action: {
              title: 'Sign in',
              callback: () => {
                dialogsActions.openDialog(DIALOGS.SIGNIN);
              }
            }
          });
          return;
        }

        let avatar = {
          'name': this.avatarName,
          'head': this.$.heads_carousel.selected,
          'body': this.$.bodies_carousel.selected,
          'legs': this.$.legs_carousel.selected
        }
        this.participants.participant = avatar;
        participantsActions.setUserParticipant(this.user.uid, avatar);
      }
    }

    window.customElements.define(AvatarPage.is, AvatarPage);
  </script>
</dom-module>
